{"version":3,"sources":["extras/controls/firstPersonControls.js"],"names":[],"mappings":"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","file":"firstPersonControls.js","sourcesContent":["import * as THREE from 'three';\r\nimport {extend} from '../api';\r\n\r\nconst PI_2 = Math.PI / 2;\r\n\r\nexport function firstPersonControls(object, params = {}) {\r\n  return function (world) {\r\n    const target = extend(params, {\r\n      block: document.getElementById('blocker'),\r\n      speed: 1,\r\n      ypos: 1\r\n    });\r\n\r\n    let controls = new (function (camera, mesh, params) {\r\n      const velocityFactor = 1;\r\n      let runVelocity = 0.25;\r\n\r\n      mesh.setAngularFactor({x: 0, y: 0, z: 0});\r\n\r\n      /* Init */\r\n      let scope = this;\r\n      const player = mesh,\r\n        pitchObject = new THREE.Object3D();\r\n\r\n      pitchObject.add(camera.getNative());\r\n\r\n      const yawObject = new THREE.Object3D();\r\n\r\n      yawObject.position.y = params.ypos; // eyes are 2 meters above the ground\r\n      yawObject.add(pitchObject);\r\n\r\n      const quat = new THREE.Quaternion();\r\n\r\n      let canJump = false,\r\n        // Moves.\r\n        moveForward = false,\r\n        moveBackward = false,\r\n        moveLeft = false,\r\n        moveRight = false;\r\n\r\n      player.addEventListener('collision', (otherObject, v, r, contactNormal) => {\r\n        if (contactNormal.y < 0.5) // Use a \"good\" threshold value between 0 and 1 here!\r\n          canJump = true;\r\n      });\r\n\r\n      function onMouseMove(event) {\r\n        if (scope.enabled === false) return;\r\n\r\n        const movementX = typeof event.movementX === 'number'\r\n          ? event.movementX : typeof event.mozMovementX === 'number'\r\n          ? event.mozMovementX : typeof event.getMovementX === 'function'\r\n          ? event.getMovementX() : 0;\r\n        const movementY = typeof event.movementY === 'number'\r\n          ? event.movementY : typeof event.mozMovementY === 'number'\r\n          ? event.mozMovementY : typeof event.getMovementY === 'function'\r\n          ? event.getMovementY() : 0;\r\n\r\n        yawObject.rotation.y -= movementX * 0.002;\r\n        pitchObject.rotation.x -= movementY * 0.002;\r\n\r\n        pitchObject.rotation.x = Math.max(-PI_2, Math.min(PI_2, pitchObject.rotation.x));\r\n      }\r\n\r\n      function onKeyDown(event) {\r\n        switch (event.keyCode) {\r\n          case 38: // up\r\n          case 87: // w\r\n            moveForward = true;\r\n            break;\r\n\r\n          case 37: // left\r\n          case 65: // a\r\n            moveLeft = true;\r\n            break;\r\n\r\n          case 40: // down\r\n          case 83: // s\r\n            moveBackward = true;\r\n            break;\r\n\r\n          case 39: // right\r\n          case 68: // d\r\n            moveRight = true;\r\n            break;\r\n\r\n          case 32: // space\r\n            if (canJump === true) {\r\n              player.applyCentralImpulse({x: 0, y: 300, z: 0});\r\n            }\r\n            canJump = false;\r\n            break;\r\n\r\n          case 16: // shift\r\n            runVelocity = 0.5;\r\n            break;\r\n\r\n          default:\r\n        }\r\n      }\r\n\r\n      function onKeyUp(event) {\r\n        switch (event.keyCode) {\r\n          case 38: // up\r\n          case 87: // w\r\n            moveForward = false;\r\n            break;\r\n\r\n          case 37: // left\r\n          case 65: // a\r\n            moveLeft = false;\r\n            break;\r\n\r\n          case 40: // down\r\n          case 83: // a\r\n            moveBackward = false;\r\n            break;\r\n\r\n          case 39: // right\r\n          case 68: // d\r\n            moveRight = false;\r\n            break;\r\n\r\n          case 16: // shift\r\n            runVelocity = 0.25;\r\n            break;\r\n\r\n          default:\r\n        }\r\n      }\r\n\r\n      document.body.addEventListener('mousemove', onMouseMove, false);\r\n      document.body.addEventListener('keydown', onKeyDown, false);\r\n      document.body.addEventListener('keyup', onKeyUp, false);\r\n\r\n      this.enabled = false;\r\n\r\n      this.getObject = () => {\r\n        return yawObject;\r\n      };\r\n\r\n      this.getDirection = (targetVec) => {\r\n        targetVec.set(0, 0, -1);\r\n        quat.multiplyVector3(targetVec);\r\n      };\r\n\r\n      // Moves the camera to the Cannon.js object position\r\n      // and adds velocity to the object if the run key is down.\r\n      const inputVelocity = new THREE.Vector3(),\r\n        euler = new THREE.Euler();\r\n\r\n      this.update = (delta) => {\r\n        if (scope.enabled === false) return;\r\n\r\n        delta = delta || 0.5;\r\n        delta = Math.min(delta, 0.5);\r\n\r\n        inputVelocity.set(0, 0, 0);\r\n\r\n        const speed = velocityFactor * delta * params.speed * runVelocity;\r\n\r\n        if (moveForward) inputVelocity.z = -speed;\r\n        if (moveBackward) inputVelocity.z = speed;\r\n        if (moveLeft) inputVelocity.x = -speed;\r\n        if (moveRight) inputVelocity.x = speed;\r\n\r\n        // Convert velocity to world coordinates\r\n        euler.x = pitchObject.rotation.x;\r\n        euler.y = yawObject.rotation.y;\r\n        euler.order = 'XYZ';\r\n\r\n        quat.setFromEuler(euler);\r\n\r\n        inputVelocity.applyQuaternion(quat);\r\n\r\n        player.applyCentralImpulse({x: inputVelocity.x * 10, y: 0, z: inputVelocity.z * 10});\r\n        player.setAngularVelocity({x: inputVelocity.z * 10, y: 0, z: -inputVelocity.x * 10});\r\n        player.setAngularFactor({x: 0, y: 0, z: 0});\r\n\r\n        yawObject.position.copy(player.position);\r\n      };\r\n    })(world.getCamera(), object.getNative(), target);\r\n\r\n    if ('pointerLockElement' in document\r\n        || 'mozPointerLockElement' in document\r\n        || 'webkitPointerLockElement' in document) {\r\n      const element = document.body;\r\n\r\n      world.pointerlockchange = function () {\r\n        if (document.pointerLockElement === element\r\n          || document.mozPointerLockElement === element\r\n          || document.webkitPointerLockElement === element) {\r\n          controls.enabled = true;\r\n          target.block.style.display = 'none';\r\n        } else {\r\n          controls.enabled = false;\r\n          target.block.style.display = 'block';\r\n        }\r\n      };\r\n\r\n      document.addEventListener('pointerlockchange', world.pointerlockchange, false);\r\n      document.addEventListener('mozpointerlockchange', world.pointerlockchange, false);\r\n      document.addEventListener('webkitpointerlockchange', world.pointerlockchange, false);\r\n\r\n      world.pointerlockerror = function () {\r\n        console.warn('Pointer lock error.');\r\n      };\r\n\r\n      document.addEventListener('pointerlockerror', world.pointerlockerror, false);\r\n      document.addEventListener('mozpointerlockerror', world.pointerlockerror, false);\r\n      document.addEventListener('webkitpointerlockerror', world.pointerlockerror, false);\r\n\r\n      target.block.addEventListener('click', () => {\r\n        element.requestPointerLock = element.requestPointerLock\r\n          || element.mozRequestPointerLock\r\n          || element.webkitRequestPointerLock;\r\n\r\n        element.requestFullscreen = element.requestFullscreen\r\n          || element.mozRequestFullscreen\r\n          || element.mozRequestFullScreen\r\n          || element.webkitRequestFullscreen;\r\n\r\n        if (/Firefox/i.test(navigator.userAgent)) {\r\n          const fullscreenchange = () => {\r\n            if (document.fullscreenElement === element\r\n              || document.mozFullscreenElement === element\r\n              || document.mozFullScreenElement === element) {\r\n              document.removeEventListener('fullscreenchange', fullscreenchange);\r\n              document.removeEventListener('mozfullscreenchange', fullscreenchange);\r\n\r\n              element.requestPointerLock();\r\n            }\r\n          };\r\n\r\n          document.addEventListener('fullscreenchange', fullscreenchange, false);\r\n          document.addEventListener('mozfullscreenchange', fullscreenchange, false);\r\n\r\n          element.requestFullscreen();\r\n        } else element.requestPointerLock();\r\n      });\r\n    } else console.warn('Your browser does not support the PointerLock WHS.API.');\r\n\r\n    function callback(world) {\r\n      world.getScene().add(world.controls.getObject());\r\n    }\r\n\r\n    return [controls, callback];\r\n  };\r\n}\r\n"]}