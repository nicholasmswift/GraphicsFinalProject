{"version":3,"sources":["physics/core/scene.js"],"names":[],"mappings":"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","file":"scene.js","sourcesContent":["import * as THREE from 'three';\r\nimport Worker from 'inline-worker';\r\nimport Stats from 'stats.js';\r\nimport {Eventable} from '../eventable';\r\nimport {\r\n  addObjectChildren,\r\n  MESSAGE_TYPES,\r\n  temp1Vector3,\r\n  temp1Matrix4,\r\n  REPORT_ITEMSIZE,\r\n  COLLISIONREPORT_ITEMSIZE,\r\n  VEHICLEREPORT_ITEMSIZE,\r\n  CONSTRAINTREPORT_ITEMSIZE\r\n} from '../api';\r\n\r\nexport class Scene extends THREE.Scene {\r\n  constructor(params = {}, init = {}) {\r\n    super();\r\n\r\n    Object.assign(this, new Eventable());\r\n    Eventable.make(Scene);\r\n\r\n    this._worker = new Worker(require('../worker.js'));\r\n    this._worker.transferableMessage = this._worker.webkitPostMessage || this._worker.postMessage;\r\n    this._materials_ref_counts = {};\r\n    this._objects = {};\r\n    this._vehicles = {};\r\n    this._constraints = {};\r\n    this._is_simulating = false;\r\n\r\n    const ab = new ArrayBuffer(1);\r\n    this._worker.transferableMessage(ab, [ab]);\r\n    this.SUPPORT_TRANSFERABLE = (ab.byteLength === 0);\r\n\r\n    this._worker.onmessage = (event) => {\r\n      let _temp,\r\n        data = event.data;\r\n\r\n      if (data instanceof ArrayBuffer && data.byteLength !== 1)// byteLength === 1 is the worker making a SUPPORT_TRANSFERABLE test\r\n        data = new Float32Array(data);\r\n\r\n      if (data instanceof Float32Array) {\r\n        // transferable object\r\n        switch (data[0]) {\r\n          case MESSAGE_TYPES.WORLDREPORT:\r\n            this._updateScene(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.SOFTREPORT:\r\n            this._updateSoftbodies(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.COLLISIONREPORT:\r\n            this._updateCollisions(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.VEHICLEREPORT:\r\n            this._updateVehicles(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.CONSTRAINTREPORT:\r\n            this._updateConstraints(data);\r\n            break;\r\n          default:\r\n        }\r\n      } else if (data.cmd) {\r\n        // non-transferable object\r\n        switch (data.cmd) {\r\n          case 'objectReady':\r\n            _temp = data.params;\r\n            if (this._objects[_temp]) this._objects[_temp].dispatchEvent('ready');\r\n            break;\r\n\r\n          case 'worldReady':\r\n            this.dispatchEvent('ready');\r\n            break;\r\n\r\n          case 'vehicle':\r\n            window.test = data;\r\n            break;\r\n\r\n          default:\r\n            // Do nothing, just show the message\r\n            console.debug(`Received: ${data.cmd}`);\r\n            console.dir(data.params);\r\n            break;\r\n        }\r\n      } else {\r\n        switch (data[0]) {\r\n          case MESSAGE_TYPES.WORLDREPORT:\r\n            this._updateScene(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.COLLISIONREPORT:\r\n            this._updateCollisions(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.VEHICLEREPORT:\r\n            this._updateVehicles(data);\r\n            break;\r\n\r\n          case MESSAGE_TYPES.CONSTRAINTREPORT:\r\n            this._updateConstraints(data);\r\n            break;\r\n          default:\r\n        }\r\n      }\r\n    };\r\n\r\n    params.fixedTimeStep = params.fixedTimeStep || 1 / 60;\r\n    params.rateLimit = params.rateLimit || true;\r\n\r\n    params.whs = {\r\n      softbody: init.softbody\r\n    };\r\n\r\n    this._stats = init.stats ? new Stats() : false;\r\n    this._world = init.world || false;\r\n\r\n    if (this._stats) {\r\n      this._stats.setMode(0);\r\n      this._stats.domElement.style.position = 'absolute';\r\n      this._stats.domElement.style.left = '0px';\r\n      this._stats.domElement.style.top = '48px';\r\n\r\n      this._world._dom.appendChild(this._stats.domElement);\r\n    }\r\n\r\n    this.execute('init', params);\r\n  }\r\n\r\n  _updateScene(data) {\r\n    let index = data[1];\r\n\r\n    while (index--) {\r\n      const offset = 2 + index * REPORT_ITEMSIZE;\r\n      const object = this._objects[data[offset]];\r\n\r\n      if (object === null) continue;\r\n\r\n      if (object.__dirtyPosition === false) {\r\n        object.position.set(\r\n          data[offset + 1],\r\n          data[offset + 2],\r\n          data[offset + 3]\r\n        );\r\n\r\n        object.__dirtyPosition = false;\r\n      }\r\n\r\n      if (object.__dirtyRotation === false) {\r\n        object.quaternion.set(\r\n          data[offset + 4],\r\n          data[offset + 5],\r\n          data[offset + 6],\r\n          data[offset + 7]\r\n        );\r\n\r\n        object.__dirtyRotation = false;\r\n      }\r\n\r\n      object._physijs.linearVelocity.set(\r\n        data[offset + 8],\r\n        data[offset + 9],\r\n        data[offset + 10]\r\n      );\r\n\r\n      object._physijs.angularVelocity.set(\r\n        data[offset + 11],\r\n        data[offset + 12],\r\n        data[offset + 13]\r\n      );\r\n    }\r\n\r\n    if (this.SUPPORT_TRANSFERABLE)\r\n      this._worker.transferableMessage(data.buffer, [data.buffer]); // Give the typed array back to the worker\r\n\r\n    this._is_simulating = false;\r\n    this.dispatchEvent('update');\r\n  }\r\n\r\n  _updateSoftbodies(data) {\r\n    let index = data[1],\r\n      offset = 2;\r\n\r\n    while (index--) {\r\n      const size = data[offset + 1];\r\n      const object = this._objects[data[offset]];\r\n\r\n      if (object === null) continue;\r\n\r\n      const association = object._physijs.aIdxAssoc;\r\n      const attributes = object.geometry.attributes;\r\n\r\n      const volumePositions = attributes.position.array;\r\n      const volumeNormals = attributes.normal.array;\r\n\r\n      const offsetVert = offset + 2;\r\n\r\n      if (object._physijs.type === \"softTrimesh\") {\r\n        for (let i = 0; i < size; i++) {\r\n          const offs = offsetVert + i * 6;\r\n\r\n          const x = data[offs];\r\n          const y = data[offs + 1];\r\n          const z = data[offs + 2];\r\n\r\n          const nx = data[offs + 3];\r\n          const ny = data[offs + 4];\r\n          const nz = data[offs + 5];\r\n\r\n          const assocVertex = association[i];\r\n\r\n          for (let k = 0, kl = assocVertex.length; k < kl; k++) {\r\n            let indexVertex = assocVertex[k];\r\n\r\n            volumePositions[indexVertex] = x;\r\n            volumeNormals[indexVertex] = nx;\r\n            indexVertex++;\r\n\r\n            volumePositions[indexVertex] = y;\r\n            volumeNormals[indexVertex] = ny;\r\n            indexVertex++;\r\n\r\n            volumePositions[indexVertex] = z;\r\n            volumeNormals[indexVertex] = nz;\r\n          }\r\n        }\r\n      } else {\r\n        for (let i = 0; i < size; i++) {\r\n          const offs = offsetVert + i * 6;\r\n\r\n          const x = data[offs];\r\n          const y = data[offs + 1];\r\n          const z = data[offs + 2];\r\n\r\n          const nx = data[offs + 3];\r\n          const ny = data[offs + 4];\r\n          const nz = data[offs + 5];\r\n\r\n          volumePositions[i * 3] = x;\r\n          volumePositions[i * 3 + 1] = y;\r\n          volumePositions[i * 3 + 2] = z;\r\n\r\n          volumeNormals[i * 3] = nx;\r\n          volumeNormals[i * 3 + 1] = ny;\r\n          volumeNormals[i * 3 + 2] = nz;\r\n        }\r\n      }\r\n\r\n      attributes.position.needsUpdate = true;\r\n      attributes.normal.needsUpdate = true;\r\n\r\n      offset += 2 + size * 6;\r\n    }\r\n\r\n    // if (this.SUPPORT_TRANSFERABLE)\r\n    //   this._worker.transferableMessage(data.buffer, [data.buffer]); // Give the typed array back to the worker\r\n\r\n    this._is_simulating = false;\r\n  }\r\n\r\n  _updateVehicles(data) {\r\n    let vehicle, wheel;\r\n\r\n    for (let i = 0; i < (data.length - 1) / VEHICLEREPORT_ITEMSIZE; i++) {\r\n      const offset = 1 + i * VEHICLEREPORT_ITEMSIZE;\r\n      vehicle = this._vehicles[data[offset]];\r\n\r\n      if (vehicle === null) continue;\r\n\r\n      wheel = vehicle.wheels[data[offset + 1]];\r\n\r\n      wheel.position.set(\r\n        data[offset + 2],\r\n        data[offset + 3],\r\n        data[offset + 4]\r\n      );\r\n\r\n      wheel.quaternion.set(\r\n        data[offset + 5],\r\n        data[offset + 6],\r\n        data[offset + 7],\r\n        data[offset + 8]\r\n      );\r\n    }\r\n\r\n    if (this.SUPPORT_TRANSFERABLE)\r\n      this._worker.transferableMessage(data.buffer, [data.buffer]); // Give the typed array back to the worker\r\n  }\r\n\r\n  _updateConstraints(data) {\r\n    let constraint, object;\r\n\r\n    for (let i = 0; i < (data.length - 1) / CONSTRAINTREPORT_ITEMSIZE; i++) {\r\n      const offset = 1 + i * CONSTRAINTREPORT_ITEMSIZE;\r\n      constraint = this._constraints[data[offset]];\r\n      object = this._objects[data[offset + 1]];\r\n\r\n      if (constraint === undefined || object === undefined) continue;\r\n\r\n      temp1Vector3.set(\r\n        data[offset + 2],\r\n        data[offset + 3],\r\n        data[offset + 4]\r\n      );\r\n\r\n      temp1Matrix4.extractRotation(object.matrix);\r\n      temp1Vector3.applyMatrix4(temp1Matrix4);\r\n\r\n      constraint.positiona.addVectors(object.position, temp1Vector3);\r\n      constraint.appliedImpulse = data[offset + 5];\r\n    }\r\n\r\n    if (this.SUPPORT_TRANSFERABLE)\r\n      this._worker.transferableMessage(data.buffer, [data.buffer]); // Give the typed array back to the worker\r\n  }\r\n\r\n  _updateCollisions(data) {\r\n    /**\r\n     * #TODO\r\n     * This is probably the worst way ever to handle collisions. The inherent evilness is a residual\r\n     * effect from the previous version's evilness which mutated when switching to transferable objects.\r\n     *\r\n     * If you feel inclined to make this better, please do so.\r\n     */\r\n\r\n    const collisions = {},\r\n      normal_offsets = {};\r\n\r\n    // Build collision manifest\r\n    for (let i = 0; i < data[1]; i++) {\r\n      const offset = 2 + i * COLLISIONREPORT_ITEMSIZE;\r\n      const object = data[offset];\r\n      const object2 = data[offset + 1];\r\n\r\n      normal_offsets[`${object}-${object2}`] = offset + 2;\r\n      normal_offsets[`${object2}-${object}`] = -1 * (offset + 2);\r\n\r\n      // Register collisions for both the object colliding and the object being collided with\r\n      if (!collisions[object]) collisions[object] = [];\r\n      collisions[object].push(object2);\r\n\r\n      if (!collisions[object2]) collisions[object2] = [];\r\n      collisions[object2].push(object);\r\n    }\r\n\r\n    // Deal with collisions\r\n    for (const id1 in this._objects) {\r\n      if (!this._objects.hasOwnProperty(id1)) continue;\r\n      const object = this._objects[id1];\r\n      if (object === null) continue;\r\n\r\n      // If object touches anything, ...\r\n      if (collisions[id1]) {\r\n        // Clean up touches array\r\n        for (let j = 0; j < object._physijs.touches.length; j++) {\r\n          if (collisions[id1].indexOf(object._physijs.touches[j]) === -1)\r\n            object._physijs.touches.splice(j--, 1);\r\n        }\r\n\r\n        // Handle each colliding object\r\n        for (let j = 0; j < collisions[id1].length; j++) {\r\n          const id2 = collisions[id1][j];\r\n          const object2 = this._objects[id2];\r\n\r\n          if (object2) {\r\n            // If object was not already touching object2, notify object\r\n            if (object._physijs.touches.indexOf(id2) === -1) {\r\n              object._physijs.touches.push(id2);\r\n\r\n              temp1Vector3.subVectors(object.getLinearVelocity(), object2.getLinearVelocity());\r\n              const temp1 = temp1Vector3.clone();\r\n\r\n              temp1Vector3.subVectors(object.getAngularVelocity(), object2.getAngularVelocity());\r\n              const temp2 = temp1Vector3.clone();\r\n\r\n              let normal_offset = normal_offsets[`${object._physijs.id}-${object2._physijs.id}`];\r\n\r\n              if (normal_offset > 0) {\r\n                temp1Vector3.set(\r\n                  -data[normal_offset],\r\n                  -data[normal_offset + 1],\r\n                  -data[normal_offset + 2]\r\n                );\r\n              } else {\r\n                normal_offset *= -1;\r\n\r\n                temp1Vector3.set(\r\n                  data[normal_offset],\r\n                  data[normal_offset + 1],\r\n                  data[normal_offset + 2]\r\n                );\r\n              }\r\n\r\n              object.dispatchEvent('collision', object2, temp1, temp2, temp1Vector3);\r\n            }\r\n          }\r\n        }\r\n      } else object._physijs.touches.length = 0; // not touching other objects\r\n    }\r\n\r\n    this.collisions = collisions;\r\n\r\n    if (this.SUPPORT_TRANSFERABLE)\r\n      this._worker.transferableMessage(data.buffer, [data.buffer]); // Give the typed array back to the worker\r\n  }\r\n\r\n  addConstraint(constraint, show_marker) {\r\n    this._constraints[constraint.id] = constraint;\r\n    this.execute('addConstraint', constraint.getDefinition());\r\n\r\n    if (show_marker) {\r\n      let marker;\r\n\r\n      switch (constraint.type) {\r\n        case 'point':\r\n          marker = new THREE.Mesh(\r\n            new THREE.SphereGeometry(1.5),\r\n            new THREE.MeshNormalMaterial()\r\n          );\r\n\r\n          marker.position.copy(constraint.positiona);\r\n          this._objects[constraint.objecta].add(marker);\r\n          break;\r\n\r\n        case 'hinge':\r\n          marker = new THREE.Mesh(\r\n            new THREE.SphereGeometry(1.5),\r\n            new THREE.MeshNormalMaterial()\r\n          );\r\n\r\n          marker.position.copy(constraint.positiona);\r\n          this._objects[constraint.objecta].add(marker);\r\n          break;\r\n\r\n        case 'slider':\r\n          marker = new THREE.Mesh(\r\n            new THREE.BoxGeometry(10, 1, 1),\r\n            new THREE.MeshNormalMaterial()\r\n          );\r\n\r\n          marker.position.copy(constraint.positiona);\r\n\r\n          // This rotation isn't right if all three axis are non-0 values\r\n          // TODO: change marker's rotation order to ZYX\r\n          marker.rotation.set(\r\n            constraint.axis.y, // yes, y and\r\n            constraint.axis.x, // x axis are swapped\r\n            constraint.axis.z\r\n          );\r\n          this._objects[constraint.objecta].add(marker);\r\n          break;\r\n\r\n        case 'conetwist':\r\n          marker = new THREE.Mesh(\r\n            new THREE.SphereGeometry(1.5),\r\n            new THREE.MeshNormalMaterial()\r\n          );\r\n\r\n          marker.position.copy(constraint.positiona);\r\n          this._objects[constraint.objecta].add(marker);\r\n          break;\r\n\r\n        case 'dof':\r\n          marker = new THREE.Mesh(\r\n            new THREE.SphereGeometry(1.5),\r\n            new THREE.MeshNormalMaterial()\r\n          );\r\n\r\n          marker.position.copy(constraint.positiona);\r\n          this._objects[constraint.objecta].add(marker);\r\n          break;\r\n        default:\r\n      }\r\n    }\r\n\r\n    return constraint;\r\n  }\r\n\r\n  onSimulationResume() {\r\n    this.execute('onSimulationResume', {});\r\n  }\r\n\r\n  removeConstraint(constraint) {\r\n    if (this._constraints[constraint.id] !== undefined) {\r\n      this.execute('removeConstraint', {id: constraint.id});\r\n      delete this._constraints[constraint.id];\r\n    }\r\n  }\r\n\r\n  execute(cmd, params) {\r\n    this._worker.postMessage({cmd, params});\r\n  }\r\n\r\n  add(object) {\r\n    THREE.Mesh.prototype.add.call(this, object);\r\n\r\n    if (object._physijs) {\r\n      object.world = this;\r\n\r\n      if (object instanceof Physijs.Vehicle) {\r\n        this.add(object.mesh);\r\n        this._vehicles[object._physijs.id] = object;\r\n        this.execute('addVehicle', object._physijs);\r\n      } else {\r\n        object.__dirtyPosition = false;\r\n        object.__dirtyRotation = false;\r\n        this._objects[object._physijs.id] = object;\r\n\r\n        if (object.children.length) {\r\n          object._physijs.children = [];\r\n          addObjectChildren(object, object);\r\n        }\r\n\r\n        if (object.material._physijs) {\r\n          if (this._materials_ref_counts.hasOwnProperty(object.material._physijs.id))\r\n            this._materials_ref_counts[object.material._physijs.id]++;\r\n          else {\r\n            this.execute('registerMaterial', object.material._physijs);\r\n            object._physijs.materialId = object.material._physijs.id;\r\n            this._materials_ref_counts[object.material._physijs.id] = 1;\r\n          }\r\n        }\r\n\r\n        // Object starting position + rotation\r\n        object._physijs.position = {\r\n          x: object.position.x,\r\n          y: object.position.y,\r\n          z: object.position.z\r\n        };\r\n\r\n        object._physijs.rotation = {\r\n          x: object.quaternion.x,\r\n          y: object.quaternion.y,\r\n          z: object.quaternion.z,\r\n          w: object.quaternion.w\r\n        };\r\n\r\n        // Check for scaling\r\n        // var mass_scaling = new THREE.Vector3(1, 1, 1);\r\n\r\n        if (object._physijs.width) object._physijs.width *= object.scale.x;\r\n        if (object._physijs.height) object._physijs.height *= object.scale.y;\r\n        if (object._physijs.depth) object._physijs.depth *= object.scale.z;\r\n\r\n        this.execute('addObject', object._physijs);\r\n      }\r\n    }\r\n  }\r\n\r\n  remove(object) {\r\n    if (object instanceof Physijs.Vehicle) {\r\n      this.execute('removeVehicle', {id: object._physijs.id});\r\n      while (object.wheels.length) this.remove(object.wheels.pop());\r\n\r\n      this.remove(object.mesh);\r\n      this._vehicles[object._physijs.id] = null;\r\n    } else {\r\n      THREE.Mesh.prototype.remove.call(this, object);\r\n\r\n      if (object._physijs) {\r\n        this._objects[object._physijs.id] = null;\r\n        this.execute('removeObject', {id: object._physijs.id});\r\n      }\r\n    }\r\n    if (object.material && object.material._physijs && this._materials_ref_counts.hasOwnProperty(object.material._physijs.id)) {\r\n      this._materials_ref_counts[object.material._physijs.id]--;\r\n\r\n      if (this._materials_ref_counts[object.material._physijs.id] === 0) {\r\n        this.execute('unRegisterMaterial', object.material._physijs);\r\n        this._materials_ref_counts[object.material._physijs.id] = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  setFixedTimeStep(fixedTimeStep) {\r\n    if (fixedTimeStep) this.execute('setFixedTimeStep', fixedTimeStep);\r\n  }\r\n\r\n  setGravity(gravity) {\r\n    if (gravity) this.execute('setGravity', gravity);\r\n  }\r\n\r\n  simulate(timeStep, maxSubSteps) {\r\n    if (this._stats) this._stats.begin();\r\n\r\n    if (this._is_simulating) return false;\r\n\r\n    this._is_simulating = true;\r\n    \r\n    for (const object_id in this._objects) {\r\n      if (!this._objects.hasOwnProperty(object_id)) continue;\r\n\r\n      const object = this._objects[object_id];\r\n\r\n      if (object !== null && (object.__dirtyPosition || object.__dirtyRotation)) {\r\n        const update = {id: object._physijs.id};\r\n\r\n        if (object.__dirtyPosition) {\r\n          update.pos = {\r\n            x: object.position.x,\r\n            y: object.position.y,\r\n            z: object.position.z\r\n          };\r\n\r\n          if (object._physijs.type === 'softbody') object.position.set(0, 0, 0);\r\n\r\n          object.__dirtyPosition = false;\r\n        }\r\n\r\n        if (object.__dirtyRotation) {\r\n          update.quat = {\r\n            x: object.quaternion.x,\r\n            y: object.quaternion.y,\r\n            z: object.quaternion.z,\r\n            w: object.quaternion.w\r\n          };\r\n\r\n          if (object._physijs.type === 'softbody') object.rotation.set(0, 0, 0);\r\n\r\n          object.__dirtyRotation = false;\r\n        }\r\n\r\n        this.execute('updateTransform', update);\r\n      }\r\n    }\r\n\r\n    this.execute('simulate', {timeStep, maxSubSteps});\r\n\r\n    if (this._stats) this._stats.end();\r\n    return true;\r\n  }\r\n}\r\n"]}